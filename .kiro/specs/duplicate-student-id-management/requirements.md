# Requirements Document

## Introduction

ระบบจัดการกระดาษคำตอบที่มีรหัสนักศึกษาซ้ำ เพื่อให้ผู้ใช้สามารถระบุและแก้ไขรหัสนักศึกษาที่ซ้ำกันได้อย่างมีประสิทธิภาพ โดยระบบจะตรวจจับกระดาษที่มีรหัสซ้ำ แสดงในตารางแยกต่างหาก และให้ผู้ใช้เลือกชื่อนักศึกษาที่ถูกต้องจาก dropdown เมื่อแก้ไขรหัสของกระดาษหนึ่งแล้ว กระดาษทั้งสองที่เคยซ้ำกันจะถูกย้ายไปยังตารางที่เหมาะสม (ตารางจับคู่ได้หรือตารางไม่จับคู่ได้) ขึ้นอยู่กับเงื่อนไขอื่นๆ เช่น การตอบซ้ำ

## Requirements

### Requirement 1: ตรวจจับและแสดงกระดาษที่มีรหัสซ้ำ

**User Story:** ในฐานะผู้ใช้ ฉันต้องการให้ระบบตรวจจับและแสดงกระดาษคำตอบที่มีรหัสนักศึกษาซ้ำกัน เพื่อที่ฉันจะได้ทราบว่ามีกระดาษไหนบ้างที่ต้องแก้ไข

#### Acceptance Criteria

1. WHEN ระบบประมวลผลกระดาษคำตอบ THEN ระบบ SHALL ตรวจสอบรหัสนักศึกษาที่ซ้ำกันในชุดกระดาษทั้งหมด
2. WHEN พบรหัสนักศึกษาซ้ำ THEN ระบบ SHALL ทำเครื่องหมายกระดาษทุกใบที่มีรหัสซ้ำกันด้วยแฟล็ก `is_duplicate = true`
3. WHEN แสดงผลลัพธ์ THEN ระบบ SHALL แสดงกระดาษที่มีรหัสซ้ำทั้งหมดในตาราง "กระดาษที่ไม่สามารถจับคู่รหัสกับชื่อได้"
4. WHEN แสดงรหัสนักศึกษาที่ซ้ำ THEN ระบบ SHALL แสดงไอคอนเตือน "⚠️ รหัสซ้ำ" ต่อท้ายรหัสนักศึกษา
5. WHEN แสดงรหัสนักศึกษาที่ซ้ำ THEN ระบบ SHALL แสดงข้อความด้วยสีแดงและตัวหนา
6. WHEN ผู้ใช้ hover เหนือรหัสที่ซ้ำ THEN ระบบ SHALL แสดง tooltip "พบรหัสนักศึกษาซ้ำ กรุณาแก้ไขรหัสให้ถูกต้อง"

### Requirement 2: บันทึกข้อมูลกระดาษที่ซ้ำแยกเป็นสองชุด

**User Story:** ในฐานะผู้ใช้ ฉันต้องการให้ระบบบันทึกข้อมูลกระดาษที่มีรหัสซ้ำแยกเป็นสองรายการอิสระ เพื่อที่ฉันจะสามารถแก้ไขแต่ละกระดาษได้อย่างอิสระ

#### Acceptance Criteria

1. WHEN พบรหัสนักศึกษาซ้ำ THEN ระบบ SHALL บันทึกข้อมูลแต่ละกระดาษเป็นรายการแยกต่างหากในผลลัพธ์
2. WHEN บันทึกข้อมูล THEN ระบบ SHALL เก็บข้อมูล `student_file` (ชื่อไฟล์) ที่แตกต่างกันสำหรับแต่ละกระดาษ
3. WHEN บันทึกข้อมูล THEN ระบบ SHALL เก็บข้อมูล `image_url` ที่แตกต่างกันสำหรับแต่ละกระดาษ
4. WHEN บันทึกข้อมูล THEN ระบบ SHALL เก็บแฟล็ก `is_duplicate = true` สำหรับกระดาษทุกใบที่มีรหัสซ้ำกัน
5. WHEN บันทึกข้อมูล THEN ระบบ SHALL เก็บรายการไฟล์ที่มีรหัสซ้ำกันใน `seen_student_ids` dictionary

### Requirement 3: เพิ่มปุ่มแก้ไขรหัสนักศึกษา

**User Story:** ในฐานะผู้ใช้ ฉันต้องการปุ่มแก้ไขรหัสนักศึกษาในแต่ละแถวของตาราง เพื่อที่ฉันจะสามารถแก้ไขรหัสที่ซ้ำได้ง่าย

#### Acceptance Criteria

1. WHEN แสดงตาราง "กระดาษที่ไม่สามารถจับคู่รหัสกับชื่อได้" THEN ระบบ SHALL แสดงปุ่ม "แก้ไขรหัส" ในคอลัมน์ "การจัดการ" สำหรับทุกแถว
2. WHEN กระดาษมีแฟล็ก `is_duplicate = true` THEN ปุ่ม "แก้ไขรหัส" SHALL มีสีที่เด่นชัดเพื่อเน้นว่าต้องแก้ไข
3. WHEN ผู้ใช้คลิกปุ่ม "แก้ไขรหัส" THEN ระบบ SHALL เปิด modal สำหรับแก้ไขรหัสนักศึกษา
4. WHEN เปิด modal THEN ระบบ SHALL แสดงรูปภาพกระดาษคำตอบที่กำลังแก้ไข
5. WHEN เปิด modal THEN ระบบ SHALL แสดงรหัสนักศึกษาปัจจุบัน

### Requirement 4: แสดง dropdown รายชื่อนักศึกษาสำหรับเลือก

**User Story:** ในฐานะผู้ใช้ ฉันต้องการเลือกชื่อนักศึกษาที่ถูกต้องจาก dropdown เพื่อที่ฉันจะได้แก้ไขรหัสได้อย่างถูกต้องและรวดเร็ว

#### Acceptance Criteria

1. WHEN เปิด modal แก้ไขรหัส THEN ระบบ SHALL แสดง dropdown ที่มีรายชื่อนักศึกษาทั้งหมดจากไฟล์รายชื่อ
2. WHEN แสดง dropdown THEN ระบบ SHALL แสดงข้อมูลในรูปแบบ "รหัสนักศึกษา - ชื่อ นามสกุล"
3. WHEN แสดง dropdown THEN ระบบ SHALL เรียงลำดับรายชื่อตามรหัสนักศึกษา
4. WHEN แสดง dropdown THEN ระบบ SHALL กรองรายชื่อที่ยังไม่ได้ถูกใช้ในผลลัพธ์ปัจจุบัน (ยกเว้นรหัสที่ซ้ำ)
5. WHEN ผู้ใช้เลือกชื่อจาก dropdown THEN ระบบ SHALL แสดงรหัสนักศึกษาใหม่ที่จะถูกบันทึก
6. IF ไม่มีไฟล์รายชื่อ THEN ระบบ SHALL แสดงข้อความแจ้งเตือนว่า "กรุณาอัปโหลดไฟล์รายชื่อนักศึกษาก่อน"

### Requirement 5: บันทึกการแก้ไขรหัสนักศึกษา

**User Story:** ในฐานะผู้ใช้ ฉันต้องการบันทึกการแก้ไขรหัสนักศึกษา เพื่อที่ระบบจะได้อัปเดตข้อมูลและย้ายกระดาษไปยังตารางที่เหมาะสม

#### Acceptance Criteria

1. WHEN ผู้ใช้คลิกปุ่ม "บันทึก" THEN ระบบ SHALL ส่งคำขอไปยัง backend เพื่ออัปเดตรหัสนักศึกษา
2. WHEN backend ได้รับคำขอ THEN ระบบ SHALL อัปเดตรหัสนักศึกษาในข้อมูลผลลัพธ์
3. WHEN อัปเดตรหัส THEN ระบบ SHALL อัปเดตชื่อนักศึกษาตามรหัสใหม่
4. WHEN อัปเดตรหัส THEN ระบบ SHALL คำนวณคะแนนใหม่ตามเฉลยที่ตั้งไว้
5. WHEN อัปเดตรหัส THEN ระบบ SHALL ตรวจสอบว่ารหัสใหม่ซ้ำกับรหัสอื่นหรือไม่
6. WHEN อัปเดตรหัส THEN ระบบ SHALL บันทึกข้อมูลลงในไฟล์ session_data.json

### Requirement 6: อัปเดตสถานะ is_duplicate หลังแก้ไข

**User Story:** ในฐานะผู้ใช้ ฉันต้องการให้ระบบอัปเดตสถานะรหัสซ้ำของกระดาษทั้งสองที่เคยซ้ำกัน เพื่อที่กระดาษทั้งสองจะได้ไม่มีสถานะซ้ำอีกต่อไป

#### Acceptance Criteria

1. WHEN แก้ไขรหัสนักศึกษาของกระดาษหนึ่ง THEN ระบบ SHALL ตรวจสอบว่ารหัสเดิมมีกระดาษอื่นที่ซ้ำกันหรือไม่
2. WHEN รหัสเดิมมีกระดาษอื่นที่ซ้ำกัน AND จำนวนกระดาษที่มีรหัสเดิมเหลือเพียง 1 ใบ THEN ระบบ SHALL เปลี่ยน `is_duplicate = false` สำหรับกระดาษที่เหลือ
3. WHEN รหัสเดิมมีกระดาษอื่นที่ซ้ำกัน AND จำนวนกระดาษที่มีรหัสเดิมมากกว่า 1 ใบ THEN กระดาษที่เหลือ SHALL ยังคงมี `is_duplicate = true`
4. WHEN เปลี่ยนรหัสเป็นรหัสใหม่ THEN ระบบ SHALL ตั้ง `is_duplicate = false` สำหรับกระดาษที่แก้ไข
5. WHEN เปลี่ยนรหัสเป็นรหัสที่มีอยู่แล้ว THEN ระบบ SHALL ตั้ง `is_duplicate = true` สำหรับกระดาษที่แก้ไขและกระดาษที่มีรหัสนั้นอยู่แล้ว

### Requirement 7: ย้ายกระดาษไปยังตารางที่เหมาะสม

**User Story:** ในฐานะผู้ใช้ ฉันต้องการให้ระบบย้ายกระดาษไปยังตารางที่เหมาะสมหลังจากแก้ไขรหัส เพื่อที่ฉันจะได้เห็นผลลัพธ์ที่ถูกต้อง

#### Acceptance Criteria

1. WHEN แก้ไขรหัสเสร็จสิ้น THEN ระบบ SHALL ตรวจสอบเงื่อนไข `has_issues` ของกระดาษที่แก้ไข
2. WHEN กระดาษไม่มี `is_duplicate = true` AND ไม่มี `multiple_answers_count > 0` AND มีชื่อในรายชื่อ THEN ระบบ SHALL ย้ายกระดาษไปยังตาราง "กระดาษที่จับคู่รหัสกับชื่อได้"
3. WHEN กระดาษยังมี `is_duplicate = true` OR `multiple_answers_count > 0` OR ไม่มีชื่อในรายชื่อ THEN ระบบ SHALL เก็บกระดาษไว้ในตาราง "กระดาษที่ไม่สามารถจับคู่รหัสกับชื่อได้"
4. WHEN ย้ายกระดาษ THEN ระบบ SHALL อัปเดตการแสดงผลในหน้าเว็บโดยอัตโนมัติ
5. WHEN ย้ายกระดาษ THEN ระบบ SHALL อัปเดตสถิติจำนวนกระดาษในแต่ละตาราง
6. WHEN กระดาษที่เคยซ้ำกันถูกแก้ไข THEN ระบบ SHALL ตรวจสอบและย้ายกระดาษอื่นที่เคยซ้ำกันด้วย (ถ้าไม่มีเงื่อนไขอื่นที่ทำให้ต้องอยู่ในตารางไม่จับคู่ได้)

### Requirement 8: แสดงข้อความยืนยันและข้อผิดพลาด

**User Story:** ในฐานะผู้ใช้ ฉันต้องการได้รับข้อความยืนยันหรือข้อผิดพลาดหลังจากแก้ไขรหัส เพื่อที่ฉันจะได้ทราบว่าการแก้ไขสำเร็จหรือไม่

#### Acceptance Criteria

1. WHEN แก้ไขรหัสสำเร็จ THEN ระบบ SHALL แสดงข้อความ "แก้ไขรหัสนักศึกษาสำเร็จ"
2. WHEN แก้ไขรหัสสำเร็จ AND กระดาษถูกย้ายไปยังตารางจับคู่ได้ THEN ระบบ SHALL แสดงข้อความ "แก้ไขรหัสนักศึกษาสำเร็จ และย้ายไปยังตารางจับคู่ได้แล้ว"
3. WHEN แก้ไขรหัสสำเร็จ AND กระดาษยังคงอยู่ในตารางไม่จับคู่ได้ THEN ระบบ SHALL แสดงข้อความพร้อมเหตุผล เช่น "แก้ไขรหัสสำเร็จ แต่ยังมีปัญหาการตอบซ้ำ"
4. WHEN เกิดข้อผิดพลาด THEN ระบบ SHALL แสดงข้อความข้อผิดพลาดที่ชัดเจน
5. WHEN รหัสใหม่ซ้ำกับรหัสอื่น THEN ระบบ SHALL แสดงข้อความเตือน "รหัสนักศึกษาที่เลือกซ้ำกับกระดาษอื่น"

### Requirement 9: รองรับทั้งโหมด Single และ Multi

**User Story:** ในฐานะผู้ใช้ ฉันต้องการให้ระบบจัดการรหัสซ้ำได้ทั้งในโหมด Single และ Multi เพื่อที่ฉันจะสามารถใช้งานได้ในทุกสถานการณ์

#### Acceptance Criteria

1. WHEN ใช้งานในโหมด Single THEN ระบบ SHALL ตรวจจับและจัดการรหัสซ้ำตามที่กำหนด
2. WHEN ใช้งานในโหมด Multi THEN ระบบ SHALL ตรวจจับและจัดการรหัสซ้ำตามที่กำหนด
3. WHEN แก้ไขรหัสในโหมด Single THEN ระบบ SHALL อัปเดตข้อมูลใน `single_results` และ `single_detailed_answers`
4. WHEN แก้ไขรหัสในโหมด Multi THEN ระบบ SHALL อัปเดตข้อมูลใน `multi_results` และ `multi_detailed_answers`
5. WHEN สลับระหว่างโหมด THEN ระบบ SHALL แสดงข้อมูลรหัสซ้ำที่ถูกต้องตามโหมดที่เลือก

### Requirement 10: บันทึกและโหลดข้อมูลจาก session

**User Story:** ในฐานะผู้ใช้ ฉันต้องการให้ระบบบันทึกการแก้ไขรหัสลงใน session เพื่อที่ฉันจะสามารถกลับมาดูหรือดาวน์โหลดผลลัพธ์ได้ในภายหลัง

#### Acceptance Criteria

1. WHEN แก้ไขรหัสนักศึกษา THEN ระบบ SHALL บันทึกข้อมูลลงในไฟล์ `session_data.json`
2. WHEN โหลดหน้าเว็บใหม่ THEN ระบบ SHALL โหลดข้อมูลจาก `session_data.json` และแสดงผลลัพธ์ที่ถูกต้อง
3. WHEN ดาวน์โหลด CSV THEN ระบบ SHALL ใช้ข้อมูลที่แก้ไขแล้วจาก session
4. WHEN สร้าง session ใหม่ THEN ระบบ SHALL ล้างข้อมูลการแก้ไขรหัสเดิม
